name: GKI Android 12-5.10 Ultimate

on:
  workflow_dispatch:
    inputs:
      ksu_commit:
        description: 'Wild_KSU Commit Hash (Kosongkan untuk Canary)'
        required: false
        default: ''

env:
  SUSFS_VERSION: "2.0.0"

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 480

    steps:
      - name: Checkout Workflow
        uses: actions/checkout@v4

      - name: Free Disk Space
        uses: endersonmenezes/free-disk-space@v3
        with:
          remove_android: true
          remove_dotnet: true
          remove_tool_cache: true
          remove_packages: "azure-cli google-cloud-cli microsoft-edge-stable google-chrome-stable firefox postgresql* temurin-* *llvm* mysql* dotnet-sdk-*"
          rm_cmd: "rmz"
          rmz_version: "3.1.1"

      - name: Install Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y bc build-essential flex bison libssl-dev libelf-dev clang lld llvm python3 curl git zip
          # Fix untuk error "ld doesn't exist" pada host kompilasi (Baseband Guard)
          sudo ln -sf /usr/bin/ld.lld /usr/bin/ld

      - name: Setup Repo Tool
        run: |
          mkdir -p ~/bin
          curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
          chmod a+x ~/bin/repo
          sudo ln -sf ~/bin/repo /usr/bin/repo
          git config --global user.email "build@kernel.resmi"
          git config --global user.name "KernelBuilder"

      - name: Repo Init & Sync
        run: |
          mkdir kernel-workspace
          cd kernel-workspace
          repo init -u https://android.googlesource.com/kernel/manifest -b common-android12-5.10 --depth=1
          repo sync -c -j$(nproc --all) --fail-fast --no-tags --force-sync --no-clone-bundle

      # --- 1. SETUP WILD KSU & BBG ---
      - name: Setup Wild KSU
        run: |
          cd kernel-workspace
          if [[ -n "${{ github.event.inputs.ksu_commit }}" ]]; then
            curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/stable/kernel/setup.sh" | bash -s "${{ github.event.inputs.ksu_commit }}"
          else
            curl -LSs "https://raw.githubusercontent.com/WildKernels/Wild_KSU/stable/kernel/setup.sh" | bash -s canary
          fi

      - name: Setup Baseband Guard
        run: |
          cd kernel-workspace
          curl -LSs https://github.com/vc-teahouse/Baseband-guard/raw/main/setup.sh | bash
          sed -i '/^config LSM$/,/^help$/{ /^[[:space:]]*default/ { /baseband_guard/! s/selinux/selinux,baseband_guard/ } }' common/security/Kconfig

      # --- 2. INTEGRATE SUSFS & FIXES ---
      - name: Integrate SUSFS & Apply WildKernels Patches
        run: |
          cd kernel-workspace
          git clone https://gitlab.com/simonpunk/susfs4ksu.git -b gki-android12-5.10 susfs_src
          git clone https://github.com/WildKernels/kernel_patches.git wild_patches
          
          SUBLEVEL=$(grep "^SUBLEVEL =" common/Makefile | awk '{print $3}')
          cp -r susfs_src/kernel_patches/fs/* common/fs/
          cp -r susfs_src/kernel_patches/include/linux/* common/include/linux/
          
          cd common
          patch -p1 < ../susfs_src/kernel_patches/50_add_susfs_in_gki-android12-5.10.patch || true
          
          if [ "$SUBLEVEL" -le 209 ]; then
            sed -i -e 's/goto show_pad;/return 0;/' ./fs/proc/task_mmu.c
          fi
          if [ "$SUBLEVEL" -le 117 ]; then
            cp ../wild_patches/ksu/susfs_fix_patches/v${{ env.SUSFS_VERSION }}/a12-5.10/fdinfo.c.patch ./
            patch -p1 < fdinfo.c.patch || true
          fi
          if [ "$SUBLEVEL" -le 43 ]; then
            cp ../wild_patches/ksu/susfs_fix_patches/v${{ env.SUSFS_VERSION }}/a12-5.10/base.c.patch ./
            patch -p1 < base.c.patch || true
          fi

      # --- 3. INJECT DEFCONFIG & BYPASS VERIFICATION ---
      - name: Configure Defconfig
        run: |
          cd kernel-workspace/common
          
          echo "Bypassing GKI defconfig check..."
          # Mematikan check_defconfig dengan mengosongkan POST_DEFCONFIG_CMDS
          echo "POST_DEFCONFIG_CMDS=\"\"" >> ../build.config.gki.aarch64

          echo "Injecting mandatory and custom configs..."
          cat <<EOF >> arch/arm64/configs/gki_defconfig
          # Mandatory for WildKSU
          CONFIG_KPROBES=y
          CONFIG_KPROBE_EVENTS=y
          CONFIG_HAVE_KPROBES=y

          # KernelSU & SUSFS
          CONFIG_KSU=y
          CONFIG_KSU_SUSFS=y
          CONFIG_SUSFS=y

          # BBG & Security
          CONFIG_BBG=y

          # KPatch & Mountify Support
          CONFIG_KALLSYMS=y
          CONFIG_KALLSYMS_ALL=y
          CONFIG_TMPFS_XATTR=y
          CONFIG_TMPFS_POSIX_ACL=y
          EOF

      # --- 4. BUILD ---
      - name: Build Kernel
        run: |
          cd kernel-workspace
          BUILD_CONFIG=common/build.config.gki.aarch64 build/build.sh

      # --- 5. ANYKERNEL3 PACKAGING ---
      - name: Prepare AnyKernel3
        run: |
          git clone https://github.com/WildKernels/AnyKernel3.git -b gki-2.0 --depth=1 AnyKernel3
          
          if [ -f "kernel-workspace/out/android12-5.10/dist/Image" ]; then
            cp "kernel-workspace/out/android12-5.10/dist/Image" "AnyKernel3/Image"
          else
            echo "Error: Image file not found!" && exit 1
          fi
          
          cd AnyKernel3
          zip -r9 "../GKI-Kernel-A12-5.10-Final.zip" * -x .git README.md

      - name: Upload Flashable Kernel
        uses: actions/upload-artifact@v4
        with:
          name: Flashable-GKI-Kernel
          path: GKI-Kernel-A12-5.10-Final.zip
